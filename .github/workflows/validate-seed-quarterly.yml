name: Quarterly Package Validation

on:
  schedule:
    # Run at 00:00 UTC on the 1st day of every 3rd month (Jan, Apr, Jul, Oct)
    - cron: '0 0 1 */3 *'
  workflow_dispatch:  # Allow manual triggering for testing

permissions:
  contents: read
  issues: write

jobs:
  validate:
    name: Validate Package Availability
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run validation with JSON output
        id: validation
        continue-on-error: true
        run: |
          bun run scripts/validate-seed-docker.ts --json > validation-results.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation-results.json
          retention-days: 90

      - name: Close previous validation issues
        if: steps.validation.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'validation-failure',
              state: 'open'
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ Closed by new quarterly validation run.'
              });
            }

      - name: Create validation failure issue
        if: steps.validation.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('validation-results.json', 'utf8'));

            // Compute quarter and year
            const date = new Date();
            const quarter = Math.floor(date.getMonth() / 3) + 1;
            const year = date.getFullYear();

            // Format issue body
            const failedSources = results.results
              .filter(r => !r.skipped && r.failed > 0)
              .sort((a, b) => b.failed - a.failed);

            const sourcesSections = failedSources.map(source => {
              const packageList = source.failedPackages
                .map(pkg => `- \`${pkg.identifier}\` (${pkg.app})`)
                .join('\n');
              return `#### ${source.source} (${source.failed}/${source.total} failed)\n\n${packageList}`;
            }).join('\n\n');

            const successRate = ((results.validPackages / results.totalPackages) * 100).toFixed(1);

            const issueBody = `## üì¶ Package Validation Report

**Date:** ${results.timestamp}
**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

### Summary

- **Total Packages:** ${results.totalPackages}
- **Valid:** ${results.validPackages} ‚úÖ
- **Failed:** ${results.failedPackages} ‚ùå
- **Skipped Sources:** ${results.skippedSources}
- **Success Rate:** ${successRate}%

### Failed Packages by Source

${sourcesSections}

### Next Steps

1. Review failed packages above
2. Check if packages were renamed, moved, or removed from repositories
3. Update package identifiers in \`seed/packages/*.json\` files
4. Re-run validation: manually trigger this workflow from Actions tab

### Artifacts

Full validation results are available in the [workflow artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).

---
*This issue was automatically generated by the quarterly package validation workflow.*`;

            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Package Validation Failures - Q${quarter} ${year}`,
              body: issueBody,
              labels: ['validation-failure', 'automated', `Q${quarter}-${year}`],
              assignees: [context.repo.owner]
            });

      - name: Fail workflow if validation failed
        if: steps.validation.outputs.exit_code != '0'
        run: |
          echo "‚ùå Package validation failed. See issue for details."
          exit 1
